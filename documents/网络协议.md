[TOC]

# FTP

## 使用

鉴于不管是`windows`还是`linux`，`ftp`作为一种大众、标准的网络协议，想来对基本的使用命令或方法亦有所定义，所以本人猜测不管是在哪个环境下的实现，`command`都是一样的。

### 登录

``` shell
# 1
$ ftp 127.0.0.1

# 2
# 输入ftp
$ ftp
# open
$ open 127.0.0.1
```

### 下载

- **type:**	查看当前的传输方式

- **ascii:**	设置传输方式为`ascii`

- **binary:**	设置传输方式为二进制方式

- **get:** 	下载

  ``` shell
  $ get filename [newname]
  ```

### 上传

- **put:**	上传指定文件
- **send:**	上传指定文件

``` shell
$ put filename [newname]
$ send filename [newname]
```

`send`和`put`用法相同，但上传速度却更快。

从`IIS`的`FTP日志`来看，`send`首先创建`数据通道`，等待客户端发送`PORT`命令；而`put`则等到服务器收到客户端的`PORT`命令后，才建立`数据通道`。

## 文件名称乱码

首先在`FTP协议`中，规定文件名称的编码为`ISO-8859-1`。

在我们从`FTP Server`读取数据时，服务器可以通过我们设置的控制连接编码对文件进行转码。

``` shell
# 服务器设置开启UTF-8编码
$ OPTS UTF8 ON
```

- `Java`实现`Apache Ftp Client`

  ``` java
  ftpClient.sendCommand("OPTS UTF8", "ON");
  // 设置控制连接的编码
  ftpClient.setControlEncoding("UTF-8");
  ```

  但我们下载数据时，首先告诉`FTP Server`我们需要下载的文件名，如果这个时候采用了其他编码，`FTP Server`往往会找不到，我们往往需要对我们提供的文件名进行转码后再进行下载。

  ``` java
  // 由于这里的文件名是通过控制端口获取的，所以在getBytes设置控制连接的编码
  client.retrieveFileStream(new String(path.getBytes(client.getControlEncoding(), "ISO8859-1")));
  ```

## OS提供FTP工具

- 注意

  在Windows与Linux使用` cd /`符号效果不同：

  - Windows

    始终在FTP根目录

  - Linux

    进入系统根目录

### Microsoft FTP service

Windows系统自带FTP服务。

- 开启Windows FTP service

https://www.cnblogs.com/liangxuru/p/6148212.html

#### 无法添加类型为“add”的重复集合项

- 参考

  https://blog.csdn.net/qq_27476581/article/details/88595242

在配置文件`applicationHost.config`中添加了重复的授权规则。我们需要找到这个文件中重复的授权规则并删除。

这个文件的目录为`C:\\Windows\system32\inetsrv\config\applicationHost.config`

### vsFTPd

`very secure FTP daemon`。

- 该工具分为服务端`vsftpd`与客户端`vsftp`

#### 安装

``` shell
# yum -y install vsftpd
```

安装成功后，生成`/etc/vsftpd.conf`配置文件

#### 使用

可通过`lsnf -i:21`查看`vsftpd`使用情况。

- 防火墙开启21端口

  因为ftp默认的端口为21，而centos默认是没有开启的，所以要修改iptables文件

  ```shell
  [root@bogon ~]# vim /etc/sysconfig/iptables
  -A INPUT -m state --state NEW -m tcp -p tcp --dport 21 -j ACCEPT
  
  在行上面有22 -j ACCEPT 下面另起一行输入跟那行差不多的，只是把22换成21，然后：wq保存。
  
  还要运行下,重启iptables
  [root@bogon ~]# service iptables restart
  ```

#### command

``` shell
# 启动
$ service vsftpd start
# 停止
$ service vsftpd stop
# 重启
$ service vsftpd restart
# 检查状态
$ servcie vsftpd status
```

#### 设置TCP最大连接数与单IP最大限制

`vsftp`分为`standalone`与`xinetd`模式：

`standalone`适用于高并发环境；

`xinetd`适用于小并发环境；

> 前段时间生产环境使用FTP协议上传文件出现`421`错误。
>
> 由于难以获取生产环境机器数据，我们依靠网上对`421`错误描述与本地环境模拟重现，认为是并发量过大引起问题产生的。

- 修改`/etc/vsftod.conf`

  - `standalone`模式

    检查`max_clients`与`max_per_ip`，默认为无限制，仅在`standalone`模式下有效。

  - `xinetd`模式

    检查`instances`与`cps`参数。

    - `instances`

      接受一个大于或等于1的整数或`UNLIMITED`，设置可以同时运行的最大进程数。

    - `cps`

      设置连接速率。它有两个参数，第一个参数表示每秒可以处理的连接数；第二个参数表示处理停止处理多少秒后，继续处理*暂停处理*的连接。

- 查看运行模式

``` shell
chkconfig -A|grep vsftpd
```

#### 会话闲置时间 idle_session_timeout

若`idle_session_timeout`时间内连接闲置，则连接断开。

- 默认值300秒

#### 参考

https://blog.51cto.com/meiling/2071122

https://blog.csdn.net/sy1084462993/article/details/80571349

## `windows`不关闭防火墙通过`FTP协议`

- `FTP协议`通过防火墙

``` shell
$ netsh advfirewall set global Statefulftp disable
```

- `Java`应用程序

``` java
System.setProperty("java.net.preferIPv4Stack", "true");
```

### 参考

https://blog.csdn.net/iteye_9130/article/details/82325170

# telnet

| 命令 | 作用 |
| ---- | ---- |
| quit | 退出 |

 

