[toc]

# 需求背景

- **User**	学生、老师及其他考试人员
- **What**	将错题生成离线文档（`PDF`)并下载

``` sequence
participant User
participant Server
participant Database
participant 题库

User - Server : 点击生成错题
Server - Database : 查询错题
Database -- Server : 返回错题
Server - 题库 : 下载错题
题库 -- Server : 返回错题
Note right of 题库 : 每个题库采用类html格式保存
Server - Server : 解析题目文本
Server - Server : 下载题目图片
Note right of Server : 每道题目中含有大量或大型图片需要下载
Server - Server : 生成PDF
Server - 云空间 : 上传
Server - User : PDF云空间地址
User - Server : 下载PDF
Server - User : PDF

```

在这个项目中，系统会根据学员的错题从容量约为10万左右的题库中抽取题目，为每个学员生成一套定制离线练习册。

因此每次考试后，将生成大量的离线文档。尤其是在大型考试中，一次考试约2000人，就要求生成2000多份文档。

其中系统第一次上线后，问题反馈最多的即离线文档生成非常慢：一份离线文档平均时长为50~55秒，部分错题较多的学生甚至需要3分钟。如果有2000个考生，2000 * 30 =110000秒，约30个小时。

- 离线文档的生成过程
  1. 分离出需要处理的题目(60~120个，平均大约80个题目左右)
  2. 解析处理题目文本，对题目中的图片下载到本地，然后调用第三方工具生成PDF文档（耗时大约40~45秒）
  3. 将PDF文档上传到云空间进行存储（耗时大约9、10秒）
  4. 提供文档地址让用户去下载打印

## 业务痛点

- 速度慢
- 实际开发人员并发编程经验少

# 目标

因此，需要开发一个并发任务执行框架以解决用户与业务开发人员的痛点：

- 提高速度

  通过并发编程，提高用户体验

- 用户要求

  1. 可以查询批量任务的执行进度

     自动清除已完成和过期任务

- 对业务开发人员友好

  1. 对批量任务提供同一的开发接口

  2. 业务开发人员使用友好

     我们需要对该框架合理封装，屏蔽并发编程实现细节


# 具体实现

经过分析后，首先我们需要实现的是针对业务开发人员的并发框架：

![image-20210406162619120](../images/并发-java/image-优化-框架结构.png)

