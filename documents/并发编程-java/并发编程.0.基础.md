[TOC]

# 基础概念

## 冯·诺曼依体系

冯·诺曼依提出了“存储程序”的思想——将各种各样不同功能程序写好后，和程序使用的数据一起存放在计算机的存储器中，然后计算器按照存储的程序取出指令加以分析，并执行指令规定操作。

他将计算机从逻辑上分为五个部件：运算器、控制器、存储器、输入设备、输出设备。

此后，原本专用计算机成为了通用的计算机，不论是计算导弹弹道、模拟核爆或计算个人所得税的程序均可在一台机器上运行。

## 进程

进程是`操作系统`进行资源分配的`最小单位`。

### 批处理系统与多道程序

批处理系统运行时，所有程序依次放入内存，CPU依次执行，在遇到`I/O操作`时严重浪费CPU的执行效率，甚至是在访问内存上指令时。

为提高CPU的执行效率，采用`多道程序思想`。

在内存上装载多个程序指令，在访问内存或`I/O`系统时，CPU将执行其他程序的指令。那么需要操作系统记录各个程序的运行状态，比如“当前运行指令”，CPU当时寄存器的值等等。

于是我们将操作系统中正在运行的程序称为`进程`,而在CPU切换进程时将当时`进程`的运行状态保存，称之为`PCB(Process Controller Block)`

### CreateProcess

`windows`创建进程API，将创建一个Process和其主线程。

### 参考

https://baike.baidu.com/item/CreateProcess/11050419?fr=aladdin

## CPU

CPU又称为`中央处理器`，由`运算器`、`控制器`、`寄存器`组成，以上元件通过`数据总线`集成。

CPU工作以`纳秒`为单位。

- 运算器 

  处理数据

- 寄存器

  存储数据

- 控制器

  控制各元件工作

- 输入设备/输出设备 （I/O）

- 数据总线

  连接各元件

> 不同的处理器，寄存器的个数、结构是不同的。

### CPU核心数和线程数的关系

![图片来自享学-Mark老师](https://github.com/Houchengisnull/git_houcheng/blob/master/documents/images/并发-java/1557544843851.png)

> 目前主流CPU都是多核的。
>
> 增加核心数目就是为了增加线程数，因为操作系统是通过线程来执行任务的。
>
> 一般情况下它们是1:1对应关系，也就是说四核CPU一般拥有四个线程。但`Intel`引入`超线程技术`后，使核心数与线程数(逻辑处理器数量)形成1:2的关系。

#### 多核心

> 单芯片多处理器( Chip Multiprocessors,简称CMP)。CMP是由美国斯坦福大学提出的。
>
> 其思想是：“**将大规模并行处理器中的SMP(对称多处理器)集成到同一芯片内,各个处理器并行执行不同的进程。**"
>
> 这种依靠多个CPU同时并行地运行程序是实现超高速计算的一个重要方向,称为`并行处理`

#### 多线程

> Simultaneous Multithreading，简称SMT。
>
> 让同一个处理器上的多个线程`同步`执行并共享处理器的执行资源。

#### 核心数、线程数

目前主流CPU都是多核的。

增加核心数目就是为了增加线程数,因为操作系统是通过线程来执行任务的,一般情况下它们是1:1对应关系,也就是说四核CPU一般拥有四个线程。但 Intel引入超线程技术后,使核心数与线程数形成1:2的关系。

### 分时系统

在`批处理系统`升级为`多道程序系统`后，CPU执行效率提升。

但是由于系统响应性问题，即我们今天常常提到的用户体验，我们再将`多道程序系统`升级为`分时系统`。

#### 多道程序系统缺陷

在多道程序系统中，在需要访问内存或`I/O`操作时将切换进程，执行其他进程。

假如内存中有一个文字处理程序与一个后台运算程序。显然，文字处理程序（比如notepad++）将常常访问`I/O`导致切换进程。而文字处理程序由于人与计算机交互频繁，对系统的响应性明显要求更高。为提高`用户体验`，创建`分时系统`。

即`CPU时间片轮转机制`，将CPU的运行时间分为`时间片`，给个进程运行一段时间，当时间片使用完后让出CPU。

> 这就需要在**PCB**中保存进程的运行时间相关信息。

#### CPU时间片轮转机制

`时间片轮转调度`是一种最古老、最简单、最公平且使用最广的算法,又称RR调度。

##### 描述

如果在时间片结束时，进程还在运行,则CPU将被剥夺并分配给另一个进程。

如果进程在时间片结束前阻塞或结来,则CPU当即进行切换。

调度程序所要做的就是维护一张`就绪进程列表`，当进程用完它的时间片后,它被移到队列的末尾。

##### 时间片长度

时间片轮转调度中唯一有趣的一点是时间片的长度。

从一个进程切换到另一个进程是需要定时间的，包括保存和装入寄存器值及内存映像，更新各种表格和队列等。

假如进程切( processwitch)，有时称为`上下文切换( context switch)`，需要5ms，再假设时间片设为20ms，则在做完20ms有用的工作之后，CPU将花费5ms来进行进程切换。CPU时间的20%被浪费在了管理开销上了。

为了提高CPU效率,我们可以将时间片设为5000ms。这时浪费的时间只有0.1%。

但考虑到在一个分时系统中，如果有10个交互用户几乎同时按下回车键，将发生什么情况？假设所有其他进程都用足它们的时间片的话,最后一个不幸的进程不得不等待5s才获得运行机会。

多数用户无法忍受一条简短命令要5才能做出响应。

##### 结论

时间片设得太短会导致过多的进程切换，降低了CPU效率；而设得太长又可能引起对短的交互请求的响应变差。

将时间片设为100ms通常是一个比较合理的折衷。

> 在CPU死机的情况下，其实大家不难发现当运行一个程序的时候把CPU给弄到了100%再不重启电脑的情况下，其实我们还是有机会把它kill掉的，我想也正是因为这种机制的缘故。——Mark老师

##### Java

JVM的多线程通过线程轮流切换并分配处理器执行时间方式来实现。

详见**JVM.note-Java内存区域与OOM-程序计数器**

### 参考

https://baijiahao.baidu.com/s?id=1609205781742300284&wfr=spider&for=pc

## 线程

### 客户就是上帝——精益求精的用户体验

即便有了`分时系统`，但某个程序一旦出现`I/O`操作仍然立马让出时间片，整个程序|进程将挂起。为了那`该死的用户体验`，为了让用户不需要忍受该死的几百毫秒，我们扒光了工程师的头发。（在批处理系统中，用户等待的时间可能是几分钟或几小时）

### 解决方案

- 多进程

  创建、销毁进程以及进程通信（进程之间数据不共享）开销大。

- 多线程

  线程是进程的一个实体,是CPU调度和分派的基本单位，它是比进程更小的、能独立运行的`基本单位`。

  - 线程依赖进程而存在
  - 仅拥有运行中必不可少单位，例如程序计数器，一组寄存器和栈。
  - 线程之间共享进程数据

> 程序计数器 存放CPU下一条工作指令地址。 ——《码农翻身》
>
> 该工作指令指向内存中某个地址，例如OxFFFFFFF0。

## 区分并行与并发

并行 同时执行

并发 交替执行

> 区分并行与并发也让我想起如何区分同时与同步。

## 高并发编程

### 意义

- 充分利用CPU资源

- 提高响应性

- 代码模块化；异步化；简单化

  > Mark:
  >
  > 例如我们实现电商系统，下订单和给用户发送短信、邮件就可以进行拆分，将给用户发送短信、邮件这两个步骤独立为单独的模块，并交给其他线程去执行。这样既增加了异步的操作，提升了系统性能，又使程序模块化,清晰化和简单化。
  >
  > 多线程应用开发的好处还有很多,大家在日后的代码编写过程中可以慢慢体会它的魅力。

### 注意事项

- 安全型

- 死锁

- 线程太多了会将服务器资源耗尽形成死机当机

  - linux线程限制数 1000；windows线程限制数 2000

    比如在JVM中，创建新线程将开辟`栈空间`，缺省值1M。类似资源还有`句柄`等。

    再比如`MySQL`最大连接数为150-200。

    均基于机器资源而考虑。